# 输出 / 错误 / 治理与限制

## 输出与错误
- 日志字段：`request_id`、`trace_id`、`db.addr`、`sql`、`rows`、`elapsed_ms`、`err`（脱敏）。
- 记录慢查询：>200ms Warn；包含绑定变量（或 hash），避免泄露敏感值。
- `ErrRecordNotFound` 视为未命中，不报警；业务自行处理。
- 返回值：模型建议定义 DTO，避免直接暴露 ORM 模型到接口层。

## 治理开关
- 连接池：必须设置 `MaxOpen/MaxIdle/Lifetime/IdleTime`；不允许使用默认 0。
- 超时：所有调用 `WithContext` 包裹 `context.WithTimeout`（读 1s、写 3s）。
- 事务：仅在逻辑需要时开启；避免长事务；事务内禁止外部 I/O。
- 自动迁移：仅在受控开关下；生产大表慎用；迁移前备份/灰度。
- 索引：模型标签同步维护；变更需评估覆盖率与锁表风险。
- 行级锁：`FOR UPDATE` 仅在事务内使用；减少锁持有时间。
- 行数校验：写操作后检查 `RowsAffected`，防止误更新 0 行。

## 限制与安全
- 禁止拼接不可信 SQL；使用参数化。
- 禁止无 where 的更新/删除；必须带条件或主键。
- 禁止在逻辑层绕过 ctx 直连 DB。
- 敏感字段（身份证/手机号/邮箱）日志需脱敏或不打。
- 不能在 hook 中做重 I/O（避免阻塞主链路）。

## 性能红线（建议）
- 单实例 QPS > 2k 前需压测与池调优。
- 慢查询阈值：默认 200ms；大查询需拆分/分页。
- 大批量写：分批 `CreateInBatches`，单批不超过 1000 行；必要时用 `LOAD DATA`。***
